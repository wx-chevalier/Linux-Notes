# MQTT

MQTT（Message Queuing Telemetry Transport，消息队列遥测传输协议），是一种基于发布/订阅（publish/subscribe）模式的轻量级通讯协议，该协议构建于 TCP/IP 协议上，由 IBM 在 1999 年发布，MQTT 已经慢慢的已经成为了 IoT 通讯的标准。

MQTT 最大优点在于，可以以极少的代码和有限的带宽，为连接远程设备提供实时可靠的消息服务。作为一种低开销、低带宽占用的即时通讯协议，使其在物联网、小型设备、移动应用等方面有较广泛的应用，譬如受限的环境中，通过卫星链路通信传感器、偶尔拨号的医疗设备、智能家居等等。

![MQTT Broker 示意](https://i.postimg.cc/pdFYRkfQ/image.png)

MQTT 协议提供一对多的消息发布，可以解除应用程序耦合，信息冗余小。该协议需要客户端和服务端，而协议中主要有三种身份：发布者（Publisher）、代理（Broker，服务器）、订阅者（Subscriber）。其中，消息的发布者和订阅者都是客户端，消息代理是服务器，而消息发布者可以同时是订阅者，实现了生产者与消费者的脱耦。

# 背景分析

## 设计原则

MQTT 协议主要是根据以下情况设计的：

- M2M（Machine to Machine），机器或设备间端到端通信，比如传感器之间的数据通讯。
- 设备（Machine）中，例如传感器，硬件能力很弱，协议要考虑尽量小的资源消耗，比如计算能力和存储等。

由于物联网的环境是非常特别的，所以 MQTT 遵循以下设计原则：

- 精简，不添加可有可无的功能；
- 发布/订阅（Pub/Sub）模式，方便消息在传感器之间传递；
- 允许用户动态创建主题，零运维成本；
- 把传输量降到最低以提高传输效率；
- 把低带宽、高延迟、不稳定的网络等因素考虑在内；
- 支持连续的会话控制；
- 理解客户端计算能力可能很低；
- 提供服务质量管理；
- 假设数据不可知，不强求传输数据的类型与格式，保持灵活性。

## 消息特性

MQTT 提供三种不同质量的消息服务：

- 至多一次：消息发布完全依赖底层 TCP/IP 网络。会发生消息丢失或重复。这一级别可用于如下情况，环境传感器数据，丢失一次读记录无所谓，因为不久后还会有第二次发送。

- 至少一次：确保消息到达，但消息重复可能会发生。

- 只有一次：确保消息到达一次。这一级别可用于如下情况，在计费系统中，消息重复或丢失会导致不正确的结果。

# 基本概念

## MQTT 客户端

一个使用 MQTT 协议的设备、应用程序等，它总是建立到服务器的网络连接。

- 可以发布信息，其他客户端可以订阅该信息
- 订阅其它客户端发布的消息
- 退订或删除应用程序的消息
- 断开与服务器连接

## MQTT 服务器

MQTT 服务器以称为 Broker（消息代理），是一个应用程序或一台设备。它是位于消息发布者 和订阅者之间。

- 接受来自客户端的网络连接
- 接受客户端发布的应用信息
- 处理来自客户端的订阅和退订请求
- 向订阅的客户转发应用程序消息

## 主题（Topic）

连接到一个应用程序消息的标签，该标签与服务器的订阅相匹配。服务器会将消息发送给订阅所匹配标签的每个客户端。

- 要订阅的主题。一个主题可以有多个级别，级别之间用斜杠字符分隔。例如/world 和 emq/emqtt/emqx 是有效的主题。

- 订阅者的 Topic name 支持通配符 `#` 和 `+`：`#` 支持一个主题内任意级别话题，`+` 只匹配一个主题级别的通配符。

- 客户端成功订阅某个主题后，代理会返回一条 SUBACK 消息，其中包含一个或多个 returnCode 参数。

MQTT 还支持主题筛选器（Topic Filter），一个对主题名通配符筛选器，在订阅表达式中使用，表示订阅所匹配到的多个主题。

## QoS（消息传递的服务质量水平）

服务质量，标志表明此主题范围内的消息传送到客户端所需的一致程度。

- 值 0：不可靠，消息基本上仅传送一次，如果当时客户端不可用，则会丢失该消息。
- 值 1：消息应传送至少 1 次。
- 值 2：消息仅传送一次。

## 会话（Session）

每个客户端与服务器建立连接后就是一个会话，客户端和服务器之间有状态交互。会话存在于一个网络之间，也可能在客户端和服务器之间跨越多个连续的网络连接。

## 订阅（Subscription）

订阅包含主题筛选器（Topic Filter）和最大服务质量（QoS）。订阅会与一个会话（Session）关联。一个会话可以包含多个订阅。每一个会话中的每个订阅都有一个不同的主题筛选器。

- 客户端在成功建立 TCP 连接之后，发送 CONNECT 消息，在得到服务器端授权允许建立彼此连接的 CONNACK 消息之后，客户端会发送 SUBSCRIBE 消息，订阅感兴趣的 Topic 主题列表（至少一个主题）

- 订阅的主题名称采用 UTF-8 编码，然后紧跟着对应的 QoS 值

## 发布（publish）

控制报文是指从客户端向服务端或者服务端向客户端传输一个应用消息，MQTT 客户端发送消息请求，发送完成后返回应用程序线程。比如安卓的推送服务，还有一些即时通信软件如微信等也是采用的推送技术。

## 负载（Payload）

消息订阅者所具体接收的内容。

# 链接

- https://www.runoob.com/w3cnote/mqtt-intro.html
